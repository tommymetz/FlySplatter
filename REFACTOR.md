# FlySplatter Refactoring Plan

This document outlines an incremental plan to modernize the FlySplatter codebase. Each step is designed to be merged and deployed independently, minimizing risk and allowing for iterative improvements.

## Current State

- **Build System**: Grunt with JSHint and UglifyJS
- **JavaScript**: ES5, prototype-based OOP, global variables
- **Architecture**: Single file (~687 lines) with tightly coupled concerns
- **Tests**: None
- **Module System**: None (global `Flies` and `Fly` constructors)

## External Usage (Important!)

The library is embedded in external projects using the following paths:

```
/flysplatter/dist/js/flysplatter.min.js
/flysplatter/dist/audio/*
/flysplatter/dist/img/*
```

⚠️ **Note:** The Vite migration will break these paths. External projects will need to switch to using the library via NPM or CDN.

---

## Step 0: Dependency Updates and Security Audit

**Goal**: Update all dependencies to their latest stable versions and ensure the project is secure. This step buys time for sustainability before making structural changes.

### Changes Required

1. **Audit current dependencies** for known vulnerabilities
2. **Update Grunt and related packages** to latest compatible versions
3. **Run security checks** with `npm audit`
4. **Verify the build still works** after updates
5. **Document current working state** for rollback if needed

### Tasks

- [ ] Run `npm audit` to check for vulnerabilities
- [ ] Run `npm outdated` to identify outdated packages
- [ ] Update Grunt to latest version
- [ ] Update grunt-contrib-jshint to latest version
- [ ] Update grunt-contrib-uglify to latest version
- [ ] Update grunt-contrib-watch to latest version
- [ ] Run build and verify output matches expected format
- [ ] Test that the game still works with updated dependencies
- [ ] Commit and tag this as a stable checkpoint

### Breaking Changes

**None** - This step only updates dependencies while maintaining the same build output.

### Build Commands (Unchanged)

```bash
cd flysplatter
npm install          # Install updated dependencies
grunt                # Build for production
grunt watch          # Watch for changes
```

---

## Step 1: Migrate from Grunt to Vite

**Goal**: Replace the outdated Grunt build system with Vite for modern bundling, faster builds, and better developer experience. This step adopts a standard Vite project structure.

### Changes Required

1. **Move source files to standard structure** using `src/` at the repository root
2. **Create package.json at repository root** with Vite as a dev dependency
3. **Create vite.config.js** configured for library mode
4. **Create .gitignore** to exclude `node_modules/` and `dist/` at root level
5. **Accept breaking change** - external projects will need to update their integration method

### New Directory Structure

```
FlySplatter/
├── src/
│   ├── index.js              # Main entry point
│   ├── flysplatter.js        # Core game code (moved from flysplatter/assets/js/)
│   └── assets/
│       ├── img/              # Image sprites
│       └── audio/            # Sound effects
├── dist/                     # Build output (generated by Vite)
│   ├── flysplatter.js        # UMD build for browser
│   ├── flysplatter.min.js    # Minified UMD build
│   └── assets/               # Copied assets
├── public/                   # Static files for demo site
│   ├── index.html            # Demo page
│   ├── flysplatter.css       # Demo styling
│   └── bg-*.jpg              # Background images
├── package.json              # At root level
├── vite.config.js            # Vite configuration
└── .gitignore                # Git ignore file
```

### Tasks

- [ ] Create `src/` directory structure
- [ ] Move `flysplatter/assets/js/flysplatter.js` to `src/flysplatter.js`
- [ ] Move `flysplatter/assets/img/` to `src/assets/img/`
- [ ] Move `flysplatter/assets/audio/` to `src/assets/audio/`
- [ ] Create `src/index.js` as main entry point
- [ ] Create root `package.json` with Vite dependencies
- [ ] Create `vite.config.js` for library mode bundling
- [ ] Create `public/` directory for demo site
- [ ] Move `index.html` to `public/index.html` and update paths
- [ ] Move styling and background images to `public/`
- [ ] Create root `.gitignore` for node_modules and dist
- [ ] Update README with new structure and build commands
- [ ] Add section explaining new embedding approaches (NPM, CDN)
- [ ] Remove old `flysplatter/` directory and Grunt files
- [ ] Test build output and demo site

### Breaking Changes

**YES** - This breaks external usage paths. External projects have two migration options:

1. **NPM Package**: Install via npm and import as a module
   ```javascript
   import Flies from 'flysplatter';
   const flies = new Flies(3, options);
   ```

2. **CDN/Direct Script**: Use the new dist path
   ```html
   <script src="https://your-cdn.com/flysplatter/dist/flysplatter.min.js"></script>
   ```

### New Build Commands

```bash
npm install          # Install dependencies
npm run dev          # Start development server with HMR
npm run build        # Build for production
npm run preview      # Preview production build
```

---

## Step 2: JavaScript Modernization (Syntax Only)

**Goal**: Update JavaScript syntax to ES6+ while maintaining the same architecture and functionality.

### Changes Required

1. **Replace `var` with `const`/`let`** throughout the codebase
2. **Convert prototype methods to ES6 classes** (`Flies` and `Fly`)
3. **Use arrow functions** where appropriate
4. **Use template literals** for string concatenation
5. **Use destructuring** for object properties
6. **Replace `docReady` with standard DOMContentLoaded** or remove entirely

### Tasks

- [ ] Convert `Flies` constructor function to ES6 class
- [ ] Convert `Fly` constructor function to ES6 class
- [ ] Replace all `var` declarations with `const`/`let`
- [ ] Convert anonymous functions to arrow functions where `this` binding allows
- [ ] Replace string concatenation with template literals
- [ ] Use object destructuring for configuration options
- [ ] Remove or modernize the `docReady` polyfill
- [ ] Remove legacy IE support (`attachEvent`)
- [ ] Update iOS detection to use modern feature detection

### Breaking Changes

**None** - External API remains identical (`new Flies(count, options)`).

---

## Step 3: Add ES Modules Support

**Goal**: Enable ES modules for better code organization. With the Vite migration already completed, this step involves splitting the monolithic file into proper modules.

### Changes Required

1. **Split the monolithic flysplatter.js** into separate module files
2. **Create separate files** for Flies and Fly classes
3. **Export classes properly** using ES module syntax
4. **Update src/index.js** to export the public API

### Tasks

- [ ] Create `src/Flies.js` with the Flies class
- [ ] Create `src/Fly.js` with the Fly class  
- [ ] Update `src/index.js` to import and export classes
- [ ] Add named exports: `export { Flies, Fly }`
- [ ] Add default export: `export default Flies`
- [ ] Configure Vite for UMD build to maintain global `Flies` variable
- [ ] Update README with ES module import examples
- [ ] Test both UMD and ESM usage patterns

### Updated Directory Structure

```
src/
├── index.js          # Main entry point with exports
├── Flies.js          # Flies class (game controller)
├── Fly.js            # Fly class (individual fly logic)
└── assets/           # Assets remain unchanged
```

### Breaking Changes

**None** - UMD build maintains global `Flies` constructor for backward compatibility.

### New Usage Option (ES Modules)

```javascript
// New ES module import (for modern projects)
import Flies from 'flysplatter';
// or
import { Flies, Fly } from 'flysplatter';
```

---

## Step 4: Eliminate Global Variables

**Goal**: Encapsulate global state within classes to prevent pollution and enable multiple independent instances.

### Changes Required

1. **Move `score` into `Flies` class** as an instance property
2. **Move `iOS` detection into a utility** or make it a class method
3. **Remove `debug` global** and replace with a configuration option

### Tasks

- [ ] Add `debug` as a configuration option in `Flies`
- [ ] Move `score` to be an instance property of `Flies`
- [ ] Pass score reference to `Fly` instances or use callback
- [ ] Create utility function for iOS detection or use feature detection
- [ ] Ensure multiple `Flies` instances can coexist independently

### Breaking Changes

**None** - External API remains identical, but behavior improves.

---

## Step 5: Separate Concerns (Audio Manager)

**Goal**: Extract audio handling into a dedicated module for better testability and maintainability.

### Changes Required

1. **Create `AudioManager` class** to handle all audio operations
2. **Extract audio preloading** logic from `Fly`
3. **Centralize volume control** and mute functionality

### Tasks

- [ ] Create `src/AudioManager.js`
- [ ] Move audio element creation to AudioManager
- [ ] Move volume fade logic to AudioManager
- [ ] Add audio pooling for better performance
- [ ] Update `Fly` to use AudioManager
- [ ] Add mute/unmute public API method

### New File Structure

```
src/
├── index.js
├── Flies.js
├── Fly.js
└── AudioManager.js
```

### Breaking Changes

**None** - Internal refactoring only.

---

## Step 6: Separate Concerns (Renderer)

**Goal**: Extract canvas rendering logic into a dedicated module.

### Changes Required

1. **Create `Renderer` class** for all canvas operations
2. **Extract sprite drawing** logic from `Fly`
3. **Centralize canvas setup** and high-DPI handling

### Tasks

- [ ] Create `src/Renderer.js`
- [ ] Move canvas creation and setup to Renderer
- [ ] Move `drawFly` and `drawSplatFly` to Renderer
- [ ] Centralize device pixel ratio handling
- [ ] Update `Fly` to use Renderer

### New File Structure

```
src/
├── index.js
├── Flies.js
├── Fly.js
├── AudioManager.js
└── Renderer.js
```

### Breaking Changes

**None** - Internal refactoring only.

---

## Step 7: Configuration and Constants

**Goal**: Extract magic numbers and configuration into a dedicated constants file.

### Changes Required

1. **Create `config.js`** with all game constants
2. **Extract sprite dimensions**, timing values, and other magic numbers
3. **Make configuration overridable** through options

### Tasks

- [ ] Create `src/config.js`
- [ ] Extract sprite frame dimensions (50x60, 100x100)
- [ ] Extract timing constants (intervals, delays)
- [ ] Extract animation parameters (step counts, random ranges)
- [ ] Allow configuration overrides in `Flies` options
- [ ] Add JSDoc documentation for all config options

### Example Config Structure

```javascript
export const CONFIG = {
  FLY_FRAME_WIDTH: 50,
  FLY_FRAME_HEIGHT: 60,
  SPLAT_FRAME_WIDTH: 100,
  SPLAT_FRAME_HEIGHT: 100,
  ANIMATION_INTERVAL: 20,
  MAX_ACTIONS_BEFORE_FLYAWAY: 5,
  // ...
};
```

### Breaking Changes

**None** - Internal refactoring with optional configuration additions.

---

## Step 8: Add Testing Infrastructure

**Goal**: Set up a testing framework and add unit tests for core functionality.

### Changes Required

1. **Add Vitest** as the testing framework (integrates well with Vite)
2. **Create test files** for each module
3. **Add mock utilities** for DOM and canvas operations

### Tasks

- [ ] Add Vitest as dev dependency
- [ ] Configure Vitest in vite.config.js
- [ ] Add test script to package.json
- [ ] Create `src/__tests__/` directory
- [ ] Add unit tests for `AudioManager`
- [ ] Add unit tests for `Renderer`
- [ ] Add unit tests for `Fly` state machine
- [ ] Add integration tests for `Flies`
- [ ] Add CI workflow for running tests

### Example Test

```javascript
// src/__tests__/AudioManager.test.js
import { describe, it, expect } from 'vitest';
import AudioManager from '../AudioManager.js';

describe('AudioManager', () => {
  it('should create audio elements', () => {
    // ...
  });
});
```

### Breaking Changes

**None** - Testing is development-only.

---

## Step 9: TypeScript Migration (Optional)

**Goal**: Add TypeScript for improved developer experience and type safety.

### Changes Required

1. **Rename files** from `.js` to `.ts`
2. **Add type annotations** to all functions and classes
3. **Create type definitions** for configuration options

### Tasks

- [ ] Add TypeScript as dev dependency
- [ ] Create `tsconfig.json`
- [ ] Rename source files to `.ts`
- [ ] Add type annotations to all classes
- [ ] Create interfaces for configuration options
- [ ] Generate `.d.ts` declaration files
- [ ] Update Vite config for TypeScript

### Breaking Changes

**None** - TypeScript compiles to JavaScript, output remains the same.

---

## Step 10: Documentation and Cleanup

**Goal**: Add comprehensive documentation and clean up legacy code.

### Tasks

- [ ] Add JSDoc comments to all public methods
- [ ] Update README with complete API documentation
- [ ] Add CONTRIBUTING.md with development guidelines
- [ ] Remove legacy Grunt files if not already done
- [ ] Add CHANGELOG.md
- [ ] Consider adding example HTML files for different use cases
- [ ] Add inline code comments for complex logic

---

## Future Considerations

These items are out of scope for the initial refactoring but worth considering:

1. **Animation System Overhaul**: Replace `setInterval` with `requestAnimationFrame` for smoother animations
2. **Touch Event Improvements**: Better touch handling with gesture support
3. **Accessibility**: Add ARIA labels and keyboard controls
4. **Performance**: Implement fly pooling instead of creating new instances
5. **PWA Support**: Add service worker for offline play
6. **Sound Sprites**: Combine audio files into a single sprite for faster loading
7. **WebGL Renderer**: Optional WebGL rendering for better performance

---

## Migration Timeline Estimate

| Step | Complexity | Estimated Effort |
|------|------------|------------------|
| 0. Dependency Updates | Low | 1-2 hours |
| 1. Grunt → Vite | Medium | 3-5 hours |
| 2. ES6+ Syntax | Low | 2-3 hours |
| 3. ES Modules | Low | 1-2 hours |
| 4. Global Variables | Low | 1-2 hours |
| 5. Audio Manager | Medium | 2-3 hours |
| 6. Renderer | Medium | 2-3 hours |
| 7. Configuration | Low | 1-2 hours |
| 8. Testing | Medium | 4-6 hours |
| 9. TypeScript | Medium | 3-4 hours |
| 10. Documentation | Low | 2-3 hours |

**Total: ~22-36 hours of work**

---

## Checklist Summary

- [x] Document current architecture
- [x] Identify breaking changes
- [x] Plan incremental migration steps
- [ ] Execute Step 0: Dependency Updates & Security
- [ ] Execute Step 1: Grunt → Vite (with standard structure)
- [ ] Execute Step 2: ES6+ Syntax
- [ ] Execute Step 3: ES Modules
- [ ] Execute Step 4: Global Variables
- [ ] Execute Step 5: Audio Manager
- [ ] Execute Step 6: Renderer
- [ ] Execute Step 7: Configuration
- [ ] Execute Step 8: Testing
- [ ] Execute Step 9: TypeScript (Optional)
- [ ] Execute Step 10: Documentation
